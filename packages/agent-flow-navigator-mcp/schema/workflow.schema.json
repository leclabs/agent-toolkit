{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agent-toolkit/flow/workflow.schema.json",
  "title": "Flow Workflow Schema",
  "description": "Graph-based workflow definition for agent orchestration",
  "type": "object",
  "required": ["id", "name", "nodes", "edges"],
  "additionalProperties": false,
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Unique workflow identifier (kebab-case)"
    },
    "name": {
      "type": "string",
      "description": "Human-readable workflow name"
    },
    "description": {
      "type": "string",
      "description": "What this workflow accomplishes"
    },
    "nodes": {
      "type": "object",
      "description": "Map of node ID to node definition",
      "additionalProperties": { "$ref": "#/$defs/node" }
    },
    "edges": {
      "type": "array",
      "description": "Directed edges connecting nodes",
      "items": { "$ref": "#/$defs/edge" }
    }
  },
  "$defs": {
    "node": {
      "oneOf": [
        { "$ref": "#/$defs/startNode" },
        { "$ref": "#/$defs/endNode" },
        { "$ref": "#/$defs/taskNode" },
        { "$ref": "#/$defs/gateNode" },
        { "$ref": "#/$defs/subflowNode" }
      ]
    },
    "startNode": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "start" },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "Arbitrary key-value data for workflow tooling and extensions"
        }
      }
    },
    "endNode": {
      "type": "object",
      "required": ["type", "result"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "end" },
        "result": {
          "type": "string",
          "enum": ["success", "failure", "blocked", "cancelled"],
          "description": "How the workflow concluded"
        },
        "escalation": {
          "type": "string",
          "enum": ["hitl", "alert", "ticket"],
          "description": "What action follows this end state"
        },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "Arbitrary key-value data for workflow tooling and extensions"
        }
      }
    },
    "taskNode": {
      "type": "object",
      "required": ["type", "name"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "task" },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "agent": { "type": "string", "description": "Agent type to perform this task" },
        "emoji": { "type": "string", "description": "Emoji to visually indicate the agent type for this step (e.g. ðŸ”§, ðŸ“‹, ðŸ‘€)" },
        "stage": {
          "type": "string",
          "description": "Workflow phase this task belongs to (e.g. planning, development, verification, delivery, analysis, investigation, design)"
        },
        "outputs": {
          "type": "array",
          "items": { "type": "string" },
          "default": ["passed", "failed"],
          "description": "Possible outcomes from this task"
        },
        "maxRetries": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "How many times this task can be retried on failure"
        },
        "config": {
          "type": "object",
          "additionalProperties": true,
          "description": "Task-specific configuration"
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "Arbitrary key-value data for workflow tooling and extensions"
        },
        "context_files": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files to load into the agent's working context for this step"
        }
      }
    },
    "gateNode": {
      "type": "object",
      "required": ["type", "name"],
      "additionalProperties": false,
      "description": "Review or approval checkpoint",
      "properties": {
        "type": { "const": "gate" },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "agent": { "type": "string" },
        "emoji": { "type": "string", "description": "Emoji to visually indicate the agent type for this step (e.g. ðŸ‘€, ðŸ§ª)" },
        "stage": {
          "type": "string",
          "description": "Workflow phase this node belongs to (e.g. planning, development, verification, delivery, analysis, investigation, design)"
        },
        "outputs": {
          "type": "array",
          "items": { "type": "string" },
          "default": ["passed", "failed"]
        },
        "maxRetries": {
          "type": "integer",
          "minimum": 0,
          "default": 0
        },
        "config": {
          "type": "object",
          "additionalProperties": true
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "Arbitrary key-value data for workflow tooling and extensions"
        },
        "context_files": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files to load into the agent's working context for this step"
        }
      }
    },
    "subflowNode": {
      "type": "object",
      "required": ["type", "workflow"],
      "additionalProperties": false,
      "description": "Connector to another workflow",
      "properties": {
        "type": { "const": "subflow" },
        "workflow": { "type": "string", "description": "ID of workflow to invoke" },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "inputs": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Input mappings to pass to subflow"
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "Arbitrary key-value data for workflow tooling and extensions"
        }
      }
    },
    "edge": {
      "type": "object",
      "required": ["from", "to"],
      "additionalProperties": false,
      "properties": {
        "from": { "type": "string", "description": "Source node ID" },
        "to": { "type": "string", "description": "Target node ID" },
        "on": {
          "type": "string",
          "description": "Output value that triggers this edge (from node's outputs)"
        },
        "label": { "type": "string", "description": "Edge description for display" },
        "condition": {
          "type": "string",
          "description": "Expression evaluated to determine if this edge should be taken (future use, currently informational)"
        }
      }
    }
  }
}
